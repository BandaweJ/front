<div class="student-dashboard-main-container">
  <div class="summary-cards-container">
    <ng-container *ngIf="(summaryLoading$ | async) || (enrolmentLoading$ | async)">
      <div class="loading-spinner">Loading student data...</div>
    </ng-container>

    <ng-container *ngIf="studentDetails$ | async as student; else noStudentData">
      <div class="summary-card student-details-card">
        <h4>Student Details</h4>
        <div class="data-item">
          <label>Name:</label>
          <span>{{ student.name }} {{ student.surname }}</span>
        </div>
        <div class="data-item">
          <label>Student Number:</label>
          <span>{{ student.studentNumber }}</span>
        </div>

        <div class="data-item">
          <label>Gender:</label>
          <span>{{ student.gender }}</span>
        </div>

        <div class="data-item">
          <label>Cell:</label>
          <span>{{ student.cell }}</span>
        </div>
        <div class="data-item">
          <label>Email:</label>
          <span>{{ student.email }}</span>
        </div>
        <div class="data-item">
          <label>Address:</label>
          <span>{{ student.address }}</span>
        </div>

      </div>
    </ng-container>
    <ng-template #noStudentData>
      <div *ngIf="!(enrolmentLoading$ | async) && !(studentDetails$ | async)" class="no-data-message">
        No student details available.
      </div>
    </ng-template>

    <ng-container *ngIf="currentEnrolment$ | async as enrolment; else noEnrolmentData">
      <div class="summary-card enrolment-details-card">
        <h4>Current Enrolment</h4>
        <div class="data-item">
          <label>Class:</label>
          <span>{{ enrolment.name }}</span>
        </div>
        <div class="data-item">
          <label>Term Number:</label>
          <span>{{ enrolment.num }}</span>
        </div>
        <div class="data-item">
          <label>Term Year:</label>
          <span>{{ enrolment.year }}</span>
        </div>
        <div class="data-item">
          <label>Residence Type:</label>
          <span>{{ enrolment.residence }}</span>
        </div>
      </div>
    </ng-container>
    <ng-template #noEnrolmentData>
      <div *ngIf="!(enrolmentLoading$ | async) && !(currentEnrolment$ | async)" class="no-data-message">
        No current enrolment data available.
      </div>
    </ng-template>


    <ng-container *ngIf="dashboardSummary$ | async as summary; else noSummaryData">
      <div class="summary-card financial-card">
        <h4>Financial Overview</h4>

        <ng-container *ngIf="summary.financialSummary as financialSummary">
          <div class="data-item">
            <label>Total Billed:</label>
            <span>{{ financialSummary.totalBilled | currency:'USD':'symbol':'1.2-2' }}</span>
          </div>
          <div class="data-item">
            <label>Total Paid:</label>
            <span>{{ financialSummary.totalPaid | currency:'USD':'symbol':'1.2-2' }}</span>
          </div>

          <div class="data-item amount-owed">
            <label>Total Amount Owed:</label>
            <span [class.positive]="(amountOwed$ | async) ?? 0 <= 0"
              [class.negative]="(amountOwed$ | async) ?? 0 > 0">
              {{ (amountOwed$ | async) ?? 0 | currency:'USD':'symbol':'1.2-2' }}
            </span>
          </div>

          <div
            *ngIf="financialSummary && financialSummary.outstandingBalances && financialSummary.outstandingBalances.length > 0"
            class="outstanding-container">
            <label class="outstanding-label">Outstanding Balances by Term:</label>
            <div *ngFor="let balance of financialSummary.outstandingBalances" class="outstanding-item">
              <span>{{ balance.term }} {{ balance.year }}:</span>
              <span class="outstanding-amount">{{ balance.amount | currency:'USD':'symbol':'1.2-2' }}</span>
            </div>
          </div>
          <ng-container *ngIf="amountOwed$ | async as amountOwed">
            <div *ngIf="financialSummary.outstandingBalances?.length === 0 && amountOwed > 0"
              class="outstanding-container">
              <label class="outstanding-label">Amount owed is not yet allocated to a term.</label>
            </div>
          </ng-container>
        </ng-container>

      </div>

      <div class="summary-card academic-card">
        <h4>Academic Overview</h4>
        <div class="data-item">
          <label>Report Cards:</label>
          <span>{{ summary.academicSummary.numberOfReportCards }}</span>
        </div>
        <div class="data-item">
          <label>Best Position:</label>
          <span *ngIf="summary.academicSummary.bestPosition">
            {{ summary.academicSummary.bestPosition.position }} ({{ summary.academicSummary.bestPosition.term }} {{
            summary.academicSummary.bestPosition.year }}, {{ summary.academicSummary.bestPosition.class }})
          </span>
          <span *ngIf="!summary.academicSummary.bestPosition" class="no-data-text">N/A</span>
        </div>
        <div class="data-item">
          <label>Worst Position:</label>
          <span *ngIf="summary.academicSummary.worstPosition">
            {{ summary.academicSummary.worstPosition.position }} ({{ summary.academicSummary.worstPosition.term }} {{
            summary.academicSummary.worstPosition.year }}, {{ summary.academicSummary.worstPosition.class }})
          </span>
          <span *ngIf="!summary.academicSummary.worstPosition" class="no-data-text">N/A</span>
        </div>
      </div>
    </ng-container>

    <ng-template #noSummaryData>
      <div *ngIf="!(summaryLoading$ | async)" class="no-data-message">
        No academic or financial summary data available for this student.
      </div>
    </ng-template>
  </div>

  <div class="continuous-analytics-container">
    <h3>Continuous Assessment Insights</h3>
    <div *ngIf="caLoading" class="loading-spinner">
      Loading analytics...
    </div>
    <ng-container *ngIf="!caLoading && caAnalytics as analytics">
      <div class="analytics-cards">
        <div class="analytics-card">
          <label>Average Score</label>
          <span>{{ analytics.averageScore | number: '1.0-1' }}%</span>
        </div>
        <div class="analytics-card">
          <label>Total Assessments</label>
          <span>{{ analytics.totalEntries }}</span>
        </div>
      </div>

      <div class="subject-averages-card" *ngIf="analytics.subjectAverages?.length">
        <h4>Average by Subject</h4>
        <div class="subject-average" *ngFor="let subject of analytics.subjectAverages">
          <span>{{ subject.subject }}</span>
          <span>{{ subject.average | number:'1.0-1' }}%</span>
        </div>
      </div>

      <div class="recent-assessments-card" *ngIf="analytics.recentAssessments?.length">
        <h4>Recent Assessments</h4>
        <div class="recent-assessment" *ngFor="let entry of analytics.recentAssessments">
          <div>
            <div class="topic">{{ entry.topicOrSkill }}</div>
            <div class="meta">{{ entry.assessmentDate | date:'mediumDate' }} â€¢ {{ entry.assessmentType }}</div>
          </div>
          <div class="score-pill">{{ entry.score }}<span *ngIf="entry.maxScore"> / {{ entry.maxScore }}</span></div>
        </div>
      </div>
    </ng-container>
    <div *ngIf="!caLoading && !caAnalytics?.totalEntries" class="no-data-message">
      No continuous assessment data available yet.
    </div>
  </div>
</div>