<mat-toolbar color="primary" class="finance-dashboard-toolbar">
  <div class="toolbar-left-content">
    <span class="toolbar-title" *ngIf="!isSearchBarVisible">Finance Dashboard</span>
    <div class="toolbar-search-container" [class.visible]="isSearchBarVisible">
      <app-search-finance-entity *ngIf="isSearchBarVisible"
        (entitySelected)="onFinancialEntitySelectedFromSearch($event)"
        class="toolbar-search-component"></app-search-finance-entity>
    </div>
  </div>

  <div class="toolbar-icons" role="toolbar" aria-label="Dashboard actions">
    <button mat-icon-button (click)="toggleSearchBar()" 
            [attr.aria-label]="isSearchBarVisible ? 'Close search' : 'Open search'"
            [attr.aria-expanded]="isSearchBarVisible">
      <mat-icon>{{ isSearchBarVisible ? 'close' : 'search' }}</mat-icon>
    </button>
    <button mat-icon-button (click)="onFilter()" 
            aria-label="Filter financial data"
            title="Filter data by criteria">
      <mat-icon>filter_list</mat-icon>
    </button>
    <button mat-icon-button [matMenuTriggerFor]="sortMenu" 
            aria-label="Sort financial data"
            [attr.aria-haspopup]="true"
            title="Sort data by different criteria">
      <mat-icon>sort</mat-icon>
    </button>
    <mat-menu #sortMenu="matMenu" role="menu">
      <button mat-menu-item *ngFor="let option of sortOptions" 
              (click)="onSortChange(option.value)"
              [attr.aria-label]="'Sort by ' + option.label"
              role="menuitem">
        {{ option.label }}
        <mat-icon *ngIf="(currentSort$ | async) === option.value" 
                  aria-hidden="true">done</mat-icon>
      </button>
    </mat-menu>
    <button mat-icon-button (click)="onClearFilters()" 
            aria-label="Clear all filters and reset view"
            title="Reset all filters">
      <mat-icon>refresh</mat-icon>
    </button>
  </div>
</mat-toolbar>

<div class="finance-dashboard-container">
  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <mat-spinner diameter="60"></mat-spinner>
    <p class="loading-text">Loading financial data...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="hasError && !isLoading" class="error-container">
    <mat-icon class="error-icon">error_outline</mat-icon>
    <h3 class="error-title">Unable to load data</h3>
    <p class="error-message">{{ errorMessage }}</p>
    <button mat-raised-button color="primary" (click)="loadData()">
      <mat-icon>refresh</mat-icon>
      Retry
    </button>
  </div>

  <!-- Main Content -->
  <div *ngIf="!isLoading && !hasError" class="dashboard-content">
    <div class="summary-cards" role="region" aria-label="Financial summary">
      <mat-card class="summary-card total-invoices-card" role="article" aria-labelledby="invoices-label">
        <div class="summary-card-content">
          <mat-icon class="card-icon" aria-hidden="true">receipt_long</mat-icon>
          <div class="summary-text">
            <div class="card-label" id="invoices-label">Total Invoices</div>
            <div class="card-value" aria-label="Total invoice amount">{{ totalInvoices$ | async | currency:'USD' }}</div>
          </div>
        </div>
      </mat-card>

      <mat-card class="summary-card total-payments-card" role="article" aria-labelledby="payments-label">
        <div class="summary-card-content">
          <mat-icon class="card-icon" aria-hidden="true">payments</mat-icon>
          <div class="summary-text">
            <div class="card-label" id="payments-label">Total Payments</div>
            <div class="card-value" aria-label="Total payment amount">{{ totalPayments$ | async | currency:'USD' }}</div>
          </div>
        </div>
      </mat-card>

      <mat-card class="summary-card total-balance-card" role="article" aria-labelledby="balance-label">
        <div class="summary-card-content">
          <mat-icon class="card-icon" aria-hidden="true">account_balance_wallet</mat-icon>
          <div class="summary-text">
            <div class="card-label" id="balance-label">Outstanding Balance</div>
            <div class="card-value" aria-label="Outstanding balance amount">{{ totalBalance$ | async | currency:'USD' }}</div>
          </div>
        </div>
      </mat-card>

      <mat-card class="summary-card collection-rate-card" role="article" aria-labelledby="collection-rate-label">
        <div class="summary-card-content">
          <mat-icon class="card-icon" aria-hidden="true">trending_up</mat-icon>
          <div class="summary-text">
            <div class="card-label" id="collection-rate-label">Collection Rate</div>
            <div class="card-value" aria-label="Collection rate percentage">{{ collectionRate$ | async | number:'1.1-1' }}%</div>
          </div>
        </div>
      </mat-card>

      <mat-card class="summary-card avg-invoice-card" role="article" aria-labelledby="avg-invoice-label">
        <div class="summary-card-content">
          <mat-icon class="card-icon" aria-hidden="true">receipt</mat-icon>
          <div class="summary-text">
            <div class="card-label" id="avg-invoice-label">Avg Invoice</div>
            <div class="card-value" aria-label="Average invoice amount">{{ averageInvoiceAmount$ | async | currency:'USD' }}</div>
          </div>
        </div>
      </mat-card>

      <mat-card class="summary-card total-transactions-card" role="article" aria-labelledby="total-transactions-label">
        <div class="summary-card-content">
          <mat-icon class="card-icon" aria-hidden="true">list_alt</mat-icon>
          <div class="summary-text">
            <div class="card-label" id="total-transactions-label">Total Transactions</div>
            <div class="card-value" aria-label="Total number of transactions">{{ totalTransactions$ | async | number }}</div>
          </div>
        </div>
      </mat-card>
      
      <mat-card class="summary-card total-enrolment-card" role="article" aria-labelledby="total-enrolment-label">
        <div class="summary-card-content">
          <mat-icon class="card-icon" aria-hidden="true">groups</mat-icon>
          <div class="summary-text">
            <div class="card-label" id="total-enrolment-label">Total Enrolled Students</div>
            <div class="card-value" aria-label="Total students enrolled">{{ enrolTotalStudents$ | async | number }}</div>
          </div>
        </div>
      </mat-card>
    </div>

  <mat-card class="chart-card">
    <mat-card-header>
      <mat-card-title>Monthly Revenue vs Payments</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="chart-container">
        <canvas #chart baseChart [options]="barChartOptions" [data]="barChartData" [type]="barChartType">
        </canvas>
      </div>
    </mat-card-content>
  </mat-card>

  <div class="tables-container">
    <mat-card class="table-card enrolment-table-card">
      <mat-card-header>
        <mat-card-title>Enrolment by Class (Current Term)</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="enrolment-table-wrapper">
          <table class="enrolment-summary-table compact" *ngIf="(enrolClassTotals$ | async) as enrolRows; else noEnrolData">
            <thead>
              <tr>
                <th>Class</th>
                <th>Total</th>
              </tr>
            </thead>
            <tbody>
              <ng-container *ngFor="let row of enrolRows">
                <tr *ngIf="row.kind === 'form'" class="form-group-header">
                  <td colspan="2">{{ row.formLabel }}</td>
                </tr>
                <tr *ngIf="row.kind === 'class'">
                  <td>{{ row.className }}</td>
                  <td>{{ row.total }}</td>
                </tr>
              </ng-container>
            </tbody>
          </table>
        </div>
      </mat-card-content>
    </mat-card>
    <mat-card class="table-card">
      <mat-card-header>
        <mat-card-title>Recent Invoices</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div *ngIf="invoicesDataSource.data.length > 0; else noDataFound">
          <table mat-table [dataSource]="invoicesDataSource" class="finance-data-table" matSort #sort1="matSort">
            <ng-container matColumnDef="transactionIcon">
              <th mat-header-cell *matHeaderCellDef></th>
              <td mat-cell *matCellDef="let element" class="icon-cell">
                <mat-icon class="icon-invoice">description</mat-icon>
              </td>
            </ng-container>
            <ng-container matColumnDef="transactionDate">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Date</th>
              <td mat-cell *matCellDef="let element">{{ element.transactionDate | date }}</td>
            </ng-container>
            <ng-container matColumnDef="studentName">
              <th mat-header-cell *matHeaderCellDef>Student</th>
              <td mat-cell *matCellDef="let element">{{ element.studentName }}</td>
            </ng-container>
            <ng-container matColumnDef="amount">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Amount</th>
              <td mat-cell *matCellDef="let element" class="amount-cell amount-invoice">
                {{ element.amount | currency:'USD' }}
              </td>
            </ng-container>
            <ng-container matColumnDef="status">
              <th mat-header-cell *matHeaderCellDef>Status</th>
              <td mat-cell *matCellDef="let element"
                [ngClass]="{'status-paid': element.status === 'Paid', 'status-overdue': element.status === 'Overdue'}">
                {{ element.status }}
              </td>
            </ng-container>
            <tr mat-header-row
              *matHeaderRowDef="['transactionIcon', 'transactionDate', 'studentName', 'amount', 'status']"></tr>
            <tr mat-row
              *matRowDef="let row; columns: ['transactionIcon', 'transactionDate', 'studentName', 'amount', 'status']">
            </tr>
          </table>
          <mat-paginator #invoicesPaginator [pageSizeOptions]="[5, 10, 20]" showFirstLastButtons></mat-paginator>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="table-card">
      <mat-card-header>
        <mat-card-title>Recent Payments</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div *ngIf="paymentsDataSource.data.length > 0; else noDataFound">
          <table mat-table [dataSource]="paymentsDataSource" class="finance-data-table" matSort #sort2="matSort">
            <ng-container matColumnDef="transactionIcon">
              <th mat-header-cell *matHeaderCellDef></th>
              <td mat-cell *matCellDef="let element" class="icon-cell">
                <mat-icon class="icon-payment">receipt</mat-icon>
              </td>
            </ng-container>
            <ng-container matColumnDef="transactionDate">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Date</th>
              <td mat-cell *matCellDef="let element">{{ element.transactionDate | date }}</td>
            </ng-container>
            <ng-container matColumnDef="studentName">
              <th mat-header-cell *matHeaderCellDef>Student</th>
              <td mat-cell *matCellDef="let element">{{ element.studentName }}</td>
            </ng-container>
            <ng-container matColumnDef="amount">
              <th mat-header-cell *matHeaderCellDef mat-sort-header>Amount</th>
              <td mat-cell *matCellDef="let element" class="amount-cell amount-payment">
                {{ element.amount | currency:'USD' }}
              </td>
            </ng-container>
            <ng-container matColumnDef="description">
              <th mat-header-cell *matHeaderCellDef>Description</th>
              <td mat-cell *matCellDef="let element">{{ element.description }}</td>
            </ng-container>
            <tr mat-header-row
              *matHeaderRowDef="['transactionIcon', 'transactionDate', 'studentName', 'amount', 'description']"></tr>
            <tr mat-row
              *matRowDef="let row; columns: ['transactionIcon', 'transactionDate', 'studentName', 'amount', 'description']">
            </tr>
          </table>
          <mat-paginator #paymentsPaginator [pageSizeOptions]="[5, 10, 20]" showFirstLastButtons></mat-paginator>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
  </div> <!-- End dashboard-content -->
</div>

<ng-template #noEnrolData>
  <div class="no-data-found">
    <mat-icon>info</mat-icon>
    <p>No enrolment records found for the current term.</p>
  </div>
</ng-template>

<ng-template #noDataFound>
  <div class="no-data-found">
    <mat-icon>info</mat-icon>
    <p>No financial records found matching your criteria.</p>
    <button mat-flat-button color="accent" (click)="onClearFilters()">Clear Filters</button>
  </div>
</ng-template>