<div class="exemption-form-container" [class.theme-dark]="currentTheme === 'dark'">
  <mat-card class="exemption-form-card">
    <mat-card-header class="card-header">
      <mat-icon class="header-icon">{{ isEditMode ? 'edit' : 'add_circle' }}</mat-icon>
      <div class="header-content">
        <mat-card-title>{{ isEditMode ? 'Edit Exemption' : 'Create New Exemption' }}</mat-card-title>
        <mat-card-subtitle>
          {{ isEditMode ? 'Update exemption details' : 'Add a new student exemption' }}
        </mat-card-subtitle>
      </div>
    </mat-card-header>

    <mat-card-content class="form-content">
      <!-- Student Search -->
      <div class="student-search-container" *ngIf="!isEditMode">
        <app-student-search (studentSelected)="studentSelected($event)"></app-student-search>
      </div>

      <!-- Selected Student Display -->
      <mat-form-field appearance="outline" class="full-width selected-student-display">
        <mat-label>Selected Student</mat-label>
        <mat-icon matPrefix>person</mat-icon>
        <input matInput [formControl]="$any(exemptionForm.get('studentName'))" readonly />
        <mat-hint *ngIf="!isEditMode">Search and select a student above</mat-hint>
        <mat-error
          *ngIf="exemptionForm.get('studentId')?.hasError('required') && exemptionForm.get('studentId')?.touched">
          A student must be selected.
        </mat-error>
      </mat-form-field>

      <!-- Exemption Type -->
      <div class="form-section">
        <label class="section-label">Exemption Type</label>
        <mat-radio-group [formControl]="$any(exemptionForm.get('type'))" class="exemption-type-radio-group">
          <mat-radio-button *ngFor="let type of exemptionTypes" [value]="type" class="exemption-radio-button">
            {{ type | titlecase | replaceUnderscores }}
          </mat-radio-button>
        </mat-radio-group>
        <mat-error *ngIf="exemptionForm.get('type')?.hasError('required') && exemptionForm.get('type')?.touched">
          Exemption type is required.
        </mat-error>
      </div>

      <!-- Fixed Amount Field -->
      <mat-form-field 
        *ngIf="exemptionForm.get('type')?.value === 'FIXED_AMOUNT' || exemptionForm.get('type')?.value === 'STAFF_SIBLING'"
        appearance="outline" 
        class="full-width">
        <mat-label>Fixed Amount</mat-label>
        <mat-icon matPrefix>attach_money</mat-icon>
        <input matInput type="number" [formControl]="$any(exemptionForm.get('fixedAmount'))" [disabled]="exemptionForm.get('type')?.value === 'STAFF_SIBLING'" />
        <mat-hint *ngIf="exemptionForm.get('type')?.value === 'STAFF_SIBLING'">Not applicable for Staff Sibling exemption</mat-hint>
        <mat-error
          *ngIf="exemptionForm.get('fixedAmount')?.hasError('required') && exemptionForm.get('fixedAmount')?.touched">
          Fixed amount is required.
        </mat-error>
        <mat-error *ngIf="exemptionForm.get('fixedAmount')?.hasError('min')">
          Amount must be positive.
        </mat-error>
      </mat-form-field>

      <!-- Percentage Amount Field -->
      <mat-form-field 
        *ngIf="exemptionForm.get('type')?.value === 'PERCENTAGE'" 
        appearance="outline" 
        class="full-width">
        <mat-label>Percentage Amount</mat-label>
        <mat-icon matPrefix>percent</mat-icon>
        <input matInput type="number" [formControl]="$any(exemptionForm.get('percentageAmount'))" />
        <mat-hint>Enter a value between 0.01 and 100</mat-hint>
        <mat-error
          *ngIf="exemptionForm.get('percentageAmount')?.hasError('required') && exemptionForm.get('percentageAmount')?.touched">
          Percentage amount is required.
        </mat-error>
        <mat-error *ngIf="exemptionForm.get('percentageAmount')?.hasError('min') || exemptionForm.get('percentageAmount')?.hasError('max')">
          Percentage must be between 0.01 and 100.
        </mat-error>
      </mat-form-field>

      <!-- Description -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Description (Optional)</mat-label>
        <mat-icon matPrefix>description</mat-icon>
        <textarea matInput [formControl]="$any(exemptionForm.get('description'))" rows="2"></textarea>
      </mat-form-field>

      <!-- Active Status -->
      <div class="form-section">
        <mat-slide-toggle [formControl]="$any(exemptionForm.get('isActive'))" color="primary">
          <span class="toggle-label">Is Active Exemption</span>
        </mat-slide-toggle>
        <mat-hint class="toggle-hint">Inactive exemptions will not be applied to invoices</mat-hint>
      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        <button 
          mat-raised-button 
          color="primary" 
          type="submit"
          (click)="onSubmit()"
          [disabled]="exemptionForm.invalid || !selectedStudent || isSubmitting">
          <mat-icon *ngIf="!isSubmitting">{{ isEditMode ? 'save' : 'add' }}</mat-icon>
          <mat-spinner *ngIf="isSubmitting" diameter="20" class="button-spinner"></mat-spinner>
          <span>{{ isSubmitting ? 'Saving...' : (isEditMode ? 'Update Exemption' : 'Create Exemption') }}</span>
        </button>
        <button mat-button type="button" (click)="onCancel()" [disabled]="isSubmitting">
          <mat-icon>cancel</mat-icon>
          Cancel
        </button>
      </div>
    </mat-card-content>
  </mat-card>
</div>

